              --select * from Activity_uf('1030','','2012-4-26','2012-5-25','')                
CREATE proc Activity_sp               
 @companyid varchar(30),                
 @companyname varchar(50),                
 @begindate datetime,                
 @enddate datetime,                
-- @sdorgid varchar(30),      ----销售区域号                
-- @SDorgname varchar(50),    ----销售区域                
 @cltcode varchar(30)      ----客户编号                
-- @cltname varchar(50)       ----客户名称                
   as    
   begin              
create  table #table               
(                
sdgroup varchar(30),            
sdgroupname varchar(30),            
 cltcode varchar(30),  ----客户编号                
 cltname varchar(50),     ----客户名称                
-- matcode varchar(30),                  
totalmoney_h money,          
 totalmoney money,            ----金额                
 All_money  money,   ----1000X1000所有产品                
 FAN_money  money,             ----福安娜                
 BJ_money  money,    ----铂金                
 XGZ_money money,    ----新贵族                
 ZHY_money money,    ----中华玉                
 JKS_money money,    ----生态石          
 SJ_money MONEY,              
    SumMoney money               ----合计                
)                
               
                
insert into #table(cltcode,totalmoney)                
select cltcode,sum(totalmoney) from isaleledgerlog a inner join IBATCHGENERAL b  
on a.BatchCode=b.BATCHCODE               
where docdate between @begindate and @enddate                
and companyid=@companyid                 
and doctype='正常销售'                
and cv10='A'                
and formid in ('11-800','11-801','11-810','11-811')                
and (isnull(@cltcode,'')='' or cltcode in (select list from getinstr(@cltcode)))                
group by cltcode                 
                
          
update #table          
set totalmoney_h=b.totalmoney          
from #table a,(select cltcode,sum(totalmoney)as totalmoney from isaleledgerlog                
where docdate between @begindate and @enddate                
and companyid=@companyid                     
and formid in ('11-800','11-801','11-810','11-811','11-805')                
and (isnull(@cltcode,'')='' or cltcode in (select list from getinstr(@cltcode)))                
group by cltcode)b          
where a.cltcode=b.cltcode             
                
create  table #tableTemp(cltcode varchar(30),MatGroup varchar(50),totalmoney money)                
insert into #tableTemp(cltcode,MatGroup,totalmoney)                
select a.cltcode,matgroup,sum(a.totalmoney) from isaleledgerlog a with (nolock) inner join iMatGeneral b with(nolock)                 
on a.matcode=b.matcode      
inner join IBATCHGENERAL c  
on a.BatchCode=c.BatchCode            
where docdate between @begindate and @enddate                
and companyid=@companyid                 
and doctype='正常销售'                
and (isnull(@cltcode,'')='' or cltcode in (select list from getinstr(@cltcode)))                
and cv10='A'                
and MatGroup in('PG-CBJZZ','PG-CFAN','PG-CXGZ','PG-CSTS','PG-CZHYS','PG-CSJY')                
and special in ('800X800')                
and formid in ('11-800','11-801','11-810','11-811','11-805')              
and a.matcode not in ('CM8009','CM8001','CB8019','CB8011','D869','D861')           
group by a.cltcode,matgroup         
      
      
      
      
      
create  table #tableText(cltcode varchar(30),totalmoney money)                
insert into #tableText(cltcode,totalmoney)                
select cltcode,sum(totalmoney) from isaleledgerlog a with(nolock) inner join iMatGeneral b with(nolock) on a.matcode=b.matcode   
inner join IBATCHGENERAL c  
on a.BatchCode=c.BatchCode                 
where docdate between @begindate and @enddate                
and companyid=@companyid                 
and doctype='正常销售'                
and cv10='A'          and formid in ('11-800','11-801','11-810','11-811','11-805')                    
and special='1000X1000'                
and (isnull(@cltcode,'')='' or cltcode in (select list from getinstr(@cltcode)))                
group by cltcode                 
                
----1000X1000所有产品金额                
update #table set All_money=b.totalmoney                
from #table a,#tableText b                 
where  a.cltcode=b.cltcode                
                
----更新福安娜金额                
update #table set FAN_money=b.totalmoney                
from #table a,#tableTemp b                 
where  a.cltcode=b.cltcode                
and matgroup='PG-CFAN'          
                
----更新铂金金额                
update #table set BJ_money=b.totalmoney                
from #table a,#tableTemp b                 
where a.cltcode=b.cltcode                
and b.MatGroup='PG-CBJZZ'                
                
----更新新贵族金额                
update #table set XGZ_money=b.totalmoney                
from #table a,#tableTemp b                 
where a.cltcode=b.cltcode                
and b.MatGroup='PG-CXGZ'                
                
----更新中华玉金额                
update #table set ZHY_money=b.totalmoney                
from #table a,#tableTemp b                 
where a.cltcode=b.cltcode                
and b.MatGroup='PG-CZHYS'                
                
----更新生态石金额                
update #table set JKS_money=b.totalmoney                
from #table a,#tableTemp b                 
where a.cltcode=b.cltcode                
and b.MatGroup='PG-CSTS'                
                
          
  ----更新生态石金额                
update #table set SJ_money=b.totalmoney                
from #table a,#tableTemp b                 
where a.cltcode=b.cltcode                
and b.MatGroup='PG-CSJY'                   
               
----更新福安娜，铂金至尊，新贵族，中华玉石，生态石金额合计                
update #table                 
set SumMoney=isnull(FAN_money,0)+isnull(BJ_money,0)+isnull(XGZ_money,0)+isnull(ZHY_money,0)+isnull(JKS_money,0)+isnull(All_money,0)+isnull(SJ_money,0)                
                
----更新客户名称                
update #table set cltname=b.cltname,sdgroup=b.SALESID,sdgroupname=b.SALESname                
from #table a,sCltGeneral b                 
where a.cltcode=b.cltcode                
            
    select * from #table        
                
return                
end 
